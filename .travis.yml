
# Initial Travic-CI control file. 6.11.15 jhrg
# Added sonar scan 3.12.19 jhrg 

dist: trusty

# Use the docker container-based build systems
sudo: false

language: java

services:
    - docker
    
# whitelist
branches:
  only:
    - master
    - travis

notifications:
  email:
    - ndp@opendap.org
    - jgallagher@opendap.org

addons:
  # ssh_known_hosts: www.opendap.org
  apt:
    packages:
      - awscli
      - sshpass

env:
  global:
    # SONAR_LOGIN, made using "travis encrypt --org -r OPENDAP/olfs SONAR_LOGIN=335df..."
    - secure: "GW672d33rdWG40v8ve25p909qnejhqWGzoX7+IEflv9hMZ+8vDWArtFaxuILhu/QeJlLJgMCrNyWdhgpSuyEJS8/EQlOUXWZfZaSPBVriayd7OKLY5D35PKODFPXbZpJ1GOheMz3roQkg+IjQzgey/zOGu4KQB9FjtcqllFvy38="
    # AWS_ACCESS_KEY_ID for the user 'travis-olfs'
    - secure: "kx7KKChePIDloGpaxHrGAGuzceYunabIOgVDhZUUGL0unzTrdl30GXPh/22Zdka5LT/rKBASfYfF3mLJWY1+xt3tpnEasZZ8ewd7kRsajIieecWnG1/UXkRAXcR2JJgy5Cs1kfk43vL1zFYrryLp2yQwDh7xkstZJe5KkWIztpDIa6jTxV0K6W+WTFgunm7gQOEJkNI+gRVaRSp2pvywyFzwV2PNP1jBw1O5pkjPhO0obvW60zoG0av6uZoAmCc9qPH4t+cQPOKWPeydIeqjSoKrQvwYnlOtsVeV1u+SNTjBttjDSgs1fJ0KsDvPkDiqD3D4lS20OIoDounvC8/VP6NVpRHcF+q/FX3vrst9qS9Z/22rsOsiR/J+hEJ9DpT8Z8fV+kQ2S5XKmH9KSWzEZHnQ/lZsrZk9THSGorf0tx1bG6dFyMegaTU+l9V9k77WdQGaoyD6ULmtJNER3kyKUhOqNsdObEpRCupFaUge0w9qiaEFBj/e29WUw9hqCdE86qhPbLIJfWy4PkuvMIrbpG8EO9PAzNrEEUlp8EwMC/zAPGFCKFjIiGljGuuTwhIX6yLix3ysOSFdufCH6mj4tUbOx2lEsI7qGuuwZKyZkP+Lrar2+BYxRZmfTVkOVHUkh7QMPHchADI6uXPBBs6UyWJ5lO2rtdu7fjeOuLdyAHc="
    # AWS_SECRET_ACCESS_KEY
    - secure: "T490llgoX6Wwo4hG1ClbwCrhMKrD00Kqgn0sKoMtrCuphoeZ076i9ewfI1R7CqaiCE9Qk8IOQBiG0fl7An4ftHgM2JX/mDnbs38hoHtXrz5ZGew3CZ5WvzTbZoSpf5eBrbo8xU8SHLZ8YvBpHQljK4c16RQv1hpEai7H7FEZbbS4Q4ffjyrHQ/fAnnW1qJ3OkxFX+GY0+d2+b+6ukfQZ6/5IWpstuSZnmiehtPrkv8Ke3rYSYcvMi2MlDqf9Vsx3UTMPyfRdd6Ns/IQRGTCnY+jp2pjVd/Hm2eY0YcPEHspNd46z/J3fooRXDJI4oQWmN4cstNIS4caXqgfIm1Yiy7kzbeKwYTaKiQ6TfNT88NjkWwsc3jKeWKE9gZqhQRuGYT/usaC8xVwNIMYvybUAG/We5fhjU4ERiY5BcsNZF6iI21r6x0FIgrefFaY4AkgnvUtlbEEF4uL2dLX00CumiFEVZLQZ9PYgHIcHHBx6W0qWWiqlVaxQJ79QEYKZBDXSf3fzZCf8qz3PpB8AIVgRiUR6R1Cqc3gHA5r2liZu/2mg1A66o74tylcXNlYhqtbkt6mwJcxquv3Agr3fowmgM/tu2NRM+FNZTBq+FV1e4xjO4FFS+lMGEOHogOgwRh/9+wTk8XYc1G0hOFz8q6jkr3aqUOe+8vZx5355yWg+Loo="
    # GIT_UID for travis-ci-opendap
    - secure: "jnuhhkxj0UlQLZSObVEi5xi0dAHObLy6S6f4hhCLKsI0nDgdL8Xj212ZubI4mlRSOgCmfbBNSSz20WgH11D7fuvPQQVyN6MMbh9OrE6JT1NEnA+Rzl+1tjWYTTBCkw1fQjchCg6fR+5Poyq4zfXOaG3H8DBZfrSGFTTdC2BdcWs="
    # GIT_PSWD for travis-ci-opendap
    - secure: "KDP1zPlruadQIbkvXHWHx6rLcTJ3P7AK2Io7IBnAiW3QETDxVksThXKY2Hey25fXw8+UV0nXuQ4v4gMNmghjvCU1k3N/vkIk9AUDC19z1IM282GumvJjZ+6WdHGvMn1sRPi3Jt3ymHoLAHiUnMbJcdc6xtAUlDCq7x2fb99sUFc="
    # WOO_UID for travis
    - secure: "jXqnDaiGjCUUAc4r865NkgbXCPfqRxrfWP+lKtAG7Lc/U6sTQBIJww1bsvfizFOdiEAgAzk4OAgE4z6djf7WbhHzyQKxGIieyLWUXoKhzAKjRYwidmKp6gBWOZSvcxURcYF2SpRAuKASpv/9lvZ3bNOlHu9LYQJ7r49AmCXJ98o="

stages:
- name: build
  if:  branch = master
- name: test
  if:  branch = master
- name: scan
  if:  branch = master AND NOT type = pull_request
- name: snappah
  if:  branch = master AND NOT type = pull_request

jobs:
  include:
    - stage: build
      script: export STAGE=build
      jdk: openjdk7
      script: ant server -DHYRAX_VERSION=CI-Build -DOLFS_VERSION=CI-Build
    - jdk: openjdk8
      script: ant server -DHYRAX_VERSION=CI-Build -DOLFS_VERSION=CI-Build

    - stage: test
      script: export STAGE=test
      jdk: openjdk7
      script: ant check
    - jdk: openjdk8
      script: ant check
    
    - stage: scan
      addons: 
        sonarcloud:
      # jdk 7 does not work with sonar scan. jhrg 3/14/19
      jdk: openjdk8
      script:
        - ant server -DHYRAX_VERSION=CI-Build -DOLFS_VERSION=CI-Build 
        - ant sonar -Dsonar.login=$SONAR_LOGIN
        - export STAGE=scan
        - echo $STAGE

    - stage: snappah
      jdk: openjdk8
      script:
        - export STAGE=snappah
        - echo $STAGE
        - export snap_tag="snapshot-"`date +%s`;
        - ant -DHYRAX_VERSION=${snap_tag} -DOLFS_VERSION=${snap_tag} -DOLFS_DIST_BASE=olfs-snapshot DISTRO
        - test -d $TRAVIS_BUILD_DIR/package || mkdir $TRAVIS_BUILD_DIR/package
        - cp ./build/dist/*.tgz $TRAVIS_BUILD_DIR/package/;    
        - echo "Checking ${TRAVIS_BUILD_DIR}/package/"     
        - ls -l ${TRAVIS_BUILD_DIR}/package/
        

# before_deploy:
#
# Get creds for pushing snapshots to w.o.o.
#- if  test "$STAGE" = "snappah";
#    then
#        ls -l ./travis;
#        openssl aes-256-cbc -K $encrypted_fa37b851f33a_key -iv $encrypted_fa37b851f33a_iv -in ./travis/woo_deploy_rsa_enc -out /tmp/woo_deploy_rsa -d;
#        eval "$(ssh-agent -s)";
#        chmod 600 /tmp/woo_deploy_rsa;
#        ssh-add /tmp/woo_deploy_rsa;
#    fi

# The deploy section copies the snapshot build product our S3 bucket
deploy:
  - provider: s3
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_ACCESS_KEY
    bucket: opendap.travis.build
    skip_cleanup: true
    local_dir: $TRAVIS_BUILD_DIR/package
    on:
      branch: master
      condition: $STAGE =~ ^snappah$

  # Push snapshot files to w.o.o
  # - provider: script
  #  skip_cleanup: true
  #  script:
  #    - scp -v $TRAVIS_BUILD_DIR/package/* $WOO_UID@www.opendap.org:/httpdocs/webdav/pub/olfs;
  #  on:
  #    branch: master
  #    condition: $STAGE =~ ^snappah$
       
# The after_deploy section grabs the hyrax-docker project, sets the current 
# snapshot time and pushes the result to GitHub. This push triggers TravisCI 
# to build the Docker containers for all of the Hyrax snapshot products. 
after_deploy:
    - ls -l ${TRAVIS_BUILD_DIR}/package/*
    - git clone https://github.com/opendap/hyrax-docker;
    - git config --global user.name "The-Robot-Travis"
    - git config --global user.email "npotter@opendap.org"
    - cd hyrax-docker/hyrax-snapshot;
    - date | tee -a snapshot.time;
    - git commit -am "The OLFS has produced new snapshot files. Triggering Hyrax-Docker image builds for snapshots.";
    - git status;
    - git push https://$GIT_UID:$GIT_PSWD@github.com/opendap/hyrax-docker --all 



    
