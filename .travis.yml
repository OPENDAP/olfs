
# Initial Travic-CI control file. 6.11.15 jhrg
# Added sonar scan 3.12.19 jhrg 

dist: trusty

# Use the docker container-based build systems
sudo: false

language: java

# Drop this and use the jdk: ... lines in the jobs: section below.
# jhrg 3/19/19
#
# jdk:
#  - openjdk7
#  - openjdk8

# whitelist
branches:
  only:
    - master
    - coverity_scan

notifications:
  email:
    - ndp@opendap.org
    - jgallagher@opendap.org

addons:
  coverity_scan:
    project:
      name: "OPENDAP/olfs"
      description: "Build submitted via Travis CI"
    notification_email: ndp@opendap.org
    build_command_prepend: "ant clean"
    build_command:   "ant server -DHYRAX_VERSION=Coverity_Build -DOLFS_VERSION=Coverity_Build"
    branch_pattern: coverity_scan

env:
  global:
   # COVERITY_SCAN_TOKEN, made with "travis encrypt" command using the project repo's public key
     - secure: "IrgvTLC1I3GKe1bFiNNXBYqwqy72+26IchD7MvHg762OhAu/Ftit9Sw5aYd5ccqDY6CgfUzQ9gJemoABodMZ4iKeYti7snlRsxo+Kv2H5kJFLRwHYPfSu2wFLcy7Spi0w8Gt2OL/DN39nUAlYvnechu9XgNalMHN4M411ZfubG8="
   # SONAR_LOGIN, made using "travis encrypt --org -r OPENDAP/olfs SONAR_LOGIN=335df..."
     - secure: "GW672d33rdWG40v8ve25p909qnejhqWGzoX7+IEflv9hMZ+8vDWArtFaxuILhu/QeJlLJgMCrNyWdhgpSuyEJS8/EQlOUXWZfZaSPBVriayd7OKLY5D35PKODFPXbZpJ1GOheMz3roQkg+IjQzgey/zOGu4KQB9FjtcqllFvy38="
     - SNAP_TAG="snapshot-"`date +%s`


stages:
- name: build
  if:  branch = master
- name: test
  if:  branch = master
- name: scan
  if:  branch = master AND NOT type = pull_request

jobs:
  include:
    - stage: build
      jdk: openjdk7
      script: ant server -DHYRAX_VERSION=CI-Build -DOLFS_VERSION=CI-Build
    - jdk: openjdk8
      script: ant server -DHYRAX_VERSION=CI-Build -DOLFS_VERSION=CI-Build

    - stage: test
      jdk: openjdk7
      script: ant check
    - jdk: openjdk8
      script: ant check
    
    - stage: scan
      addons: 
        sonarcloud:
      # jdk 7 does not work with sonar scan. jhrg 3/14/19
      jdk: openjdk8
      script:
        - ant server -DHYRAX_VERSION=CI-Build -DOLFS_VERSION=CI-Build 
        - ant sonar -Dsonar.login=$SONAR_LOGIN

before_deploy:
- test -d $TRAVIS_BUILD_DIR/package || mkdir $TRAVIS_BUILD_DIR/package
- ant -DHYRAX_VERSION=$SNAP_TAG -DOLFS_VERSION=$SNAP_TAG -DWEBAPP_DIST=snapshot 
- pwd; ls -l build/dist
# - cp ./build/dist/*.tgz $TRAVIS_BUILD_DIR/package/;         
        
deploy:
  provider: s3
  access_key_id: $AWS_ACCESS_KEY_ID
  secret_access_key: $AWS_SECRET_ACCESS_KEY
  bucket: opendap.travis.build
  skip_cleanup: true
  local_dir: $TRAVIS_BUILD_DIR/package
  on:
    branch: master

