
# Initial Travic-CI control file. 6.11.15 jhrg
# Added sonar scan 3.12.19 jhrg 

dist: trusty

# Use the docker container-based build systems
sudo: false

language: java

services:
  - docker

# whitelist
branches:
  only:
    - master
    - travis

notifications:
  email:
    - ndp@opendap.org
    - jgallagher@opendap.org

addons:
  # ssh_known_hosts: www.opendap.org
  apt:
    packages:
      - awscli

env:
  global:
    # SONAR_LOGIN, made using "travis encrypt --org -r OPENDAP/olfs SONAR_LOGIN=335df..."
    - secure: "GW672d33rdWG40v8ve25p909qnejhqWGzoX7+IEflv9hMZ+8vDWArtFaxuILhu/QeJlLJgMCrNyWdhgpSuyEJS8/EQlOUXWZfZaSPBVriayd7OKLY5D35PKODFPXbZpJ1GOheMz3roQkg+IjQzgey/zOGu4KQB9FjtcqllFvy38="
    # AWS_ACCESS_KEY_ID for the user 'travis-olfs'
    - secure: "N7FWlKcHNC4VRaNZFz/8WQlwJXjr7t4QLklJPiUY2xBw8n4lpYUuMjvDlwX7YupIKNGw8ama8GauNZhJ2h0qv08VeMF4VLOc5yUDt9BSEEnomiQZWa8N0paaSknlZP8Qq7YH2WVrlASIR+/Owdig1mqIv9GPW+ZkwdRTdRI9FZM="
    # AWS_SECRET_ACCESS_KEY
    - secure: "c70Fjj9nsL085GJlSToG6hxfuKI2uPEI4bXVggtJ7jfO6PdA1UFDq0FiqUwm14Nzi81YEjXmlF2PznieZAlzi7wh6Xa2H8xxwdx5jJCnp8wqMkNpFMk3SkdJHMCciHqMlxI1toa9JgJ/+PVPgynfBn2b0a/Ivrl0TBIkKoWoFes="
    # GIT_UID for travis-ci-opendap
    - secure: "jnuhhkxj0UlQLZSObVEi5xi0dAHObLy6S6f4hhCLKsI0nDgdL8Xj212ZubI4mlRSOgCmfbBNSSz20WgH11D7fuvPQQVyN6MMbh9OrE6JT1NEnA+Rzl+1tjWYTTBCkw1fQjchCg6fR+5Poyq4zfXOaG3H8DBZfrSGFTTdC2BdcWs="
    # GIT_PSWD for travis-ci-opendap
    - secure: "i9V81CV2PlYy4NsTSvx8XydBlBkemXIFWkWBXupViKHqOAGVfyBArm2lj/uKz6TnUcvCngDQIjeDqTOOOArxNpoHLO07PqF4be4K+i4+fctDM6lP2Rd/+p2Jc9W3mV1KSrZF/QteyUahUFCaqSTxOe3h7mI178CaGoNJdTV4k/w="
    # WOO_UID for travis
    - secure: "jXqnDaiGjCUUAc4r865NkgbXCPfqRxrfWP+lKtAG7Lc/U6sTQBIJww1bsvfizFOdiEAgAzk4OAgE4z6djf7WbhHzyQKxGIieyLWUXoKhzAKjRYwidmKp6gBWOZSvcxURcYF2SpRAuKASpv/9lvZ3bNOlHu9LYQJ7r49AmCXJ98o="
    # SNYK_TOKEN
    - secure: "A+Ll8E9FlU0B4qAYb9GTmuCFgY0RstSXiJqTuXcEmej/ppalCvCXN4t+Ss3fyy4zF3NbNh54kVhnZOL3/bDe8VihvL48MbftCfdq4kmE3UdYqdTjs6vqGl0g1UkMqdGq/uvxPhBM0ggMM1EO9aN03OtCnEehcnKtwqKVdOGzQg4="

install:
  - nvm install 12.13.0
  - npm install -g snyk
  - npm install -g snyk-gradle-plugin

stages:
  - name: build
    if:  branch = master
  - name: test
    if:  branch = master
  - name: scan
    if: branch = master
  - name: gradle
    if: branch = master
  - name: snappah
    if:  (branch = master AND NOT type = pull_request) OR (branch =~ ^(detect.*Change|.*-test-deploy)$)
  - name: hyrax-docker-trigger
    if:  (branch = master AND NOT type = pull_request) OR (branch =~ ^(detect.*Change|.*-test-deploy)$)

# caching for gradle
before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/

jobs:
  include:

    - stage: build
      name: "jdk8"
      jdk: openjdk8
      script:
        - export STAGE=build
        - ant server -DHYRAX_VERSION=CI-Build -DOLFS_VERSION=CI-Build

    - stage: build
      name: "jdk11"
      jdk: openjdk11
      script:
        - export STAGE=build
        - ant server -DHYRAX_VERSION=CI-Build -DOLFS_VERSION=CI-Build

    - stage: build
      name: "gradle (jdk11)"
      jdk: openjdk11
      script:
        - export STAGE=build
        - ./gradlew --version
        - ./gradlew tasks
        - ./gradlew war

    - stage: test
      name: "jdk7"
      jdk: openjdk7
      script:
        - export STAGE=test
        - ant check

    - stage: test
      name: "jdk8"
      jdk: openjdk8
      script:
        - export STAGE=test
        - ant check

    - stage: test
      name: "jdk11"
      jdk: openjdk11
      script:
        - export STAGE=test
        - ant check

    - stage: scan
      name: "sonarscan (jdk11)"
      jdk: openjdk11
      addons: sonarcloud
      script:
        - export STAGE=scan
        - ant server -DHYRAX_VERSION=CI-Build -DOLFS_VERSION=CI-Build
        - ant sonar -Dsonar.login=$SONAR_LOGIN -Dsonar.qualitygate.wait=true
        - curl -s https://sonarcloud.io/api/project_badges/quality_gate?project=opendap-olfs | grep "QUALITY GATE PASS"

    - stage: scan
      name: "synk (jdk11)"
      jdk: openjdk11
      script:
        - export STAGE=scan
        - echo $STAGE
        - ./run-snyk.sh

    - stage: gradle
      name: "gradle sonarscan (jdk11)"
      jdk: openjdk11
      script:
        - export STAGE=scan
        - ./gradlew buildDists sonarqube -Dsonar.login=$SONAR_LOGIN -Dsonar.qualitygate.wait=true
        - curl -s https://sonarcloud.io/api/project_badges/quality_gate?project=opendap-olfs | grep "QUALITY GATE PASS"

    - stage: snappah
      name: "olfs-snapshot (jdk8)"
      jdk: openjdk8
      script:
        - export STAGE=snappah
        - echo "STAGE is ${STAGE}"
        - test -d $TRAVIS_BUILD_DIR/package || mkdir $TRAVIS_BUILD_DIR/package
        - source ./travis/compute_build_tags.sh
        - ant -DHYRAX_VERSION="${HYRAX_BUILD_VERSION}" -DOLFS_VERSION="${OLFS_BUILD_VERSION}" -DOLFS_DIST_BASE=olfs-snapshot DISTRO
        - cp ./build/dist/*.tgz $TRAVIS_BUILD_DIR/package/;
        - echo "Built Distribution Bundles:"
        - ls -l ./build/dist/*.tgz
        - echo "Checking ${TRAVIS_BUILD_DIR}/package/"
        - ls -l ${TRAVIS_BUILD_DIR}/package/

    - stage: snappah
      name: "olfs-build-number (jdk8)"
      jdk: openjdk8
      script:
        - export STAGE=snappah
        - echo "STAGE is ${STAGE}"
        - test -d $TRAVIS_BUILD_DIR/package || mkdir $TRAVIS_BUILD_DIR/package
        - source ./travis/compute_build_tags.sh
        - ant -DHYRAX_VERSION="${HYRAX_BUILD_VERSION}" -DOLFS_VERSION="${OLFS_BUILD_VERSION}" DISTRO
        - cp ./build/dist/*.tgz $TRAVIS_BUILD_DIR/package/;
        - echo "Built Distribution Bundles:"
        - ls -l ./build/dist/*.tgz
        - echo "Checking ${TRAVIS_BUILD_DIR}/package/"
        - ls -l ${TRAVIS_BUILD_DIR}/package/

    - stage: snappah
      name: "ngap-snapshot (jdk8)"
      jdk: openjdk8
      script:
        - export STAGE=snappah
        - echo "STAGE is ${STAGE}"
        - test -d $TRAVIS_BUILD_DIR/package || mkdir $TRAVIS_BUILD_DIR/package
        - source ./travis/compute_build_tags.sh
        - ant -DHYRAX_VERSION="${HYRAX_BUILD_VERSION}" -DOLFS_VERSION="${OLFS_BUILD_VERSION}" -DNGAP_DIST_BASE=ngap-snapshot ngap-dist
        - cp ./build/dist/*.tgz $TRAVIS_BUILD_DIR/package/;
        - echo "Build Bundles:"
        - ls -l ./build/dist/*.tgz
        - echo "Checking ${TRAVIS_BUILD_DIR}/package/"
        - ls -l ${TRAVIS_BUILD_DIR}/package/

    - stage: snappah
      name: "ngap-build-number (jdk8)"
      jdk: openjdk8
      script:
        - export STAGE=snappah
        - echo "STAGE is ${STAGE}"
        - test -d $TRAVIS_BUILD_DIR/package || mkdir $TRAVIS_BUILD_DIR/package
        - source ./travis/compute_build_tags.sh
        - ant -DHYRAX_VERSION="${HYRAX_BUILD_VERSION}" -DOLFS_VERSION="${OLFS_BUILD_VERSION}" -DNGAP_DIST_BASE="ngap-${OLFS_BUILD_VERSION}" ngap-dist
        - echo "Build Bundles:"
        - ls -l ./build/dist/*.tgz
        - cp ./build/dist/*.tgz $TRAVIS_BUILD_DIR/package/;
        - echo "Checking ${TRAVIS_BUILD_DIR}/package/"
        - ls -l ${TRAVIS_BUILD_DIR}/package/

      # The hyrax-docker-trigger stage grabs the hyrax-docker project, sets the current
      # snapshot time and pushes the result to GitHub. This push triggers TravisCI
      # to build the Docker containers for all of the Hyrax snapshot products.
      # I moved this into it's own stage instead of after_deploy so that it would
      # reliably run once after everything else worked. -ndp 3/10/21
    - stage: hyrax-docker-trigger
      name: "Triggering hyrax-docker snapshot build"
      script:
        - export STAGE=hyrax-docker
        - echo $STAGE
        - source ./travis/compute_build_tags.sh
        - ./travis/trigger-hyrax-docker.sh



# before_deploy:
#
# Get creds for pushing snapshots to w.o.o.
#- if  test "$STAGE" = "snappah";
#    then
#        ls -l ./travis;
#        openssl aes-256-cbc -K $encrypted_fa37b851f33a_key -iv $encrypted_fa37b851f33a_iv -in ./travis/woo_deploy_rsa_enc -out /tmp/woo_deploy_rsa -d;
#        eval "$(ssh-agent -s)";
#        chmod 600 /tmp/woo_deploy_rsa;
#        ssh-add /tmp/woo_deploy_rsa;
#    fi



# The deploy section copies the snapshot build product our S3 bucket
deploy:
  - provider: s3
    access_key_id: $AWS_ACCESS_KEY_ID
    secret_access_key: $AWS_SECRET_ACCESS_KEY
    bucket: opendap.travis.build
    skip_cleanup: true
    local_dir: $TRAVIS_BUILD_DIR/package
    on:
    all_branches: true
    condition: $STAGE =~ ^snappah$


  # Push snapshot files to w.o.o
  # - provider: script
  #  skip_cleanup: true
  #  script:
  #    - scp -v $TRAVIS_BUILD_DIR/package/* $WOO_UID@www.opendap.org:/httpdocs/webdav/pub/olfs;
  #  on:
  #    branch: master
  #    condition: $STAGE =~ ^snappah$





    
