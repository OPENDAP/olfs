
/// This build.gradle file was adapted from the Feedback project. That project
/// built a war file using Java files that relied on teh Spring framework. In this
/// build file I have removed or commented the parts that have to do with Spring.
///
/// The build will try to use the existing organization of the Java sources in the
/// ant-based OLFS project.
///
/// jhrg 9/8/21

// The 'buildscript' block holds what gradle needs to run the build script
buildscript {
    repositories {
        //Required repos
        mavenCentral()
    }
    dependencies {
        // Required dependency for spring-boot plugin
        // jhrg classpath 'org.springframework.boot:spring-boot-gradle-plugin:2.1.0.RELEASE'
    }
}

plugins {
    id 'java'
    id 'war'
    id 'eclipse'
    id 'idea'
}

group = 'org.opendap'
version = '0.1.0-SNAPSHOT'

description = """The OLFS"""

sourceCompatibility = 1.7
targetCompatibility = 1.7

repositories {
    // For just about everything except...
    mavenCentral()
    // For: org.clojars.pjt and org.jdom
    // jcenter(); removed jhrg 9/8/21
    // For: net.sf.saxon
    maven {
        url 'https://repo.enonic.com/public'
        }
    maven { url 'https://clojars.org/repo/' }
    // I cannot get the above 'enonic' repo to work and cannot find saxon 9.1.0.8
    // anywhere. But we have 9.1.0.5 locally. jhrg 9/8/21
    flatDir {
        dirs 'lib' // 'gralde_local_repo'
    }

}

ext {
    junitVersion = '5.6.2'
}

// See https://docs.gradle.org/current/userguide/building_java_projects.html#sec:java_source_sets
// and https://docs.gradle.org/current/dsl/org.gradle.api.tasks.SourceSet.html
// jhrg 9/8/21

sourceSets {
    main {
        java {
            srcDirs = ['src']
            exclude '**/*Test.java'
            // TODO Exclude the *Test.java files but put them in a 'test' source set. jhrg 9/13/21
            // See also: https://docs.gradle.org/current/userguide/java_testing.html#java_testing
            // and https://docs.gradle.org/current/userguide/java_testing.html#sec:configuring_java_integration_tests
        }

        resources {
            // Using the following results in a copy of the 'resources//hyrax/WEB-INF'
            // dir's contents in the 'classes' dir. Probably not what we want. jhrg 9/13/21
            //
            // See the war { } task at the end of this file for the low down on how we
            // get the resources copied into the war file. jhrg 9/13/21

            //srcDirs = ['resources/hyrax']
            // , 'resources/WCS/2.0/xsl', 'resources/WCS/2.0/WEB-INF'

            //exclude 'resources/WCS/WEB-INF/web.xml'
            //exclude 'resources/WCS/WEB-INF/urlrewrite.xml'
            //exclude 'resources/WCS/WEB-INF/logback.xml'
            //exclude 'resources/WCS/WEB-INF/logback-test.xml'
        }
    }
    testMain{
        java {
            include 'src/**/*Test.java'
        }
    }
}

dependencies {
    // The biggest difference I see between the gradle file written by Slav for the Snyk
    // integration and my olf 'Feedback' project is the use of 'compile' versus
    // 'implementation' in the dependencies. I'll leave some of the old lines in here as
    // comments.
    // NB: https://docs.gradle.org/current/userguide/declaring_dependencies.html
    // jhrg 9/8/21
    //
    //    compile group: 'org.springframework.boot', name: 'spring-boot-starter-web'
    //    testCompile group: 'org.springframework.boot', name: 'spring-boot-starter-test'
    //    providedRuntime group: 'org.springframework.boot', name: 'spring-boot-starter-tomcat'

    testImplementation("org.junit.jupiter:junit-jupiter-api:${junitVersion}")
    testImplementation group: 'org.objenesis', name: 'objenesis', version: '3.2'
    testRuntimeOnly("org.junit.jupiter:junit-jupiter-engine:${junitVersion}")

    implementation group: 'junit', name: 'junit', version: '4.13.1'
    implementation group: 'org.slf4j', name: 'slf4j-api', version: '1.6.1'
    implementation group: 'com.google.code.gson', name: 'gson', version: '2.3.1'
    implementation group: 'commons-cli', name: 'commons-cli', version: '1.2'
    implementation group: 'commons-codec', name: 'commons-codec', version: '1.13'
    implementation group: 'commons-httpclient', name: 'commons-httpclient', version: '3.1'
    implementation group: 'commons-io', name: 'commons-io', version: '2.7'
    implementation group: 'commons-lang', name: 'commons-lang', version: '2.5'
    implementation group: 'commons-logging', name: 'commons-logging', version: '1.1.3'
    implementation group: 'org.owasp.encoder', name: 'encoder', version: '1.2.2'
    implementation group: 'org.jvnet.ogc', name: 'gml-v_3_2_1', version: '2.6.1'
    implementation group: 'org.jvnet.ogc', name: 'gmlcov-v_1_0', version: '2.6.1'
    implementation group: 'org.jvnet.jaxb2_commons', name: 'jaxb2-basics-runtime', version: '0.11.0'
    implementation group: 'org.jvnet.ogc', name: 'ows-v_2_0', version: '2.6.1'
    implementation group: 'org.jvnet.ogc', name: 'sweCommon-v_2_0', version: '2.6.1'
    implementation group: 'org.jvnet.ogc', name: 'wcs-v_2_0', version: '2.6.1'
    implementation group: 'com.sun.xml.bind', name: 'jaxb-core', version: '2.3.0-b170127.1453'
    implementation group: 'com.sun.xml.bind', name: 'jaxb-impl', version: '2.3.0-b170127.1453'
    implementation group: 'ch.qos.logback', name: 'logback-classic', version: '1.2.0'
    implementation group: 'org.apache.httpcomponents', name: 'httpclient', version: '4.5.13'
    implementation group: 'org.apache.httpcomponents', name: 'httpcore', version: '4.4.6'
    implementation group: 'xerces', name: 'xercesImpl', version: '2.12.1'
    implementation group: 'commons-io', name: 'commons-io', version: '1.2'
    implementation group: 'org.jdom', name: 'jdom', version: '1.1.1'

    // TODO Find a repo that will give us a recent copy of the saxon 9 code. jhrg
    // implementation group: 'net.sf.saxon', name: 'saxon', version: '9.1.0.8'
    // implementation group: 'net.sf.saxon', name: 'saxon-jdom', version: '9.1.0.8'
    // implementation group: 'org.clojars.pjt', name: 'saxon9-s9api', version: '9.1.0.8'
    implementation files('lib/saxon-9.1.0.5.jar')
    implementation files('lib/saxon-9.1.0.5-jdom.jar')
    implementation files('lib/saxon-9.1.0.5-s9api.jar')
    // I don't know if we can use the 9.1.0.8 version pulled from a maven repo (above)
    // or if we need the 9.1.0.5 version below to match the saxon jars used from a local
    // repo. jhrg 9/8/21
    // implementation files('gradle_local_repo/saxon-9.1.0.5-s9api.jar')

    implementation group: 'ch.qos.logback', name: 'logback-core', version: '1.1.11'
    implementation group: 'com.google.code.gson', name: 'gson', version: '2.3.1'

    annotationProcessor 'org.tuckey:urlrewritefilter:3.2.0'
    //hold the line above to replace the line below for upgrade to gradle 4.6, SBL 9.13.21
    //implementation group: 'org.tuckey', name: 'urlrewritefilter', version: '3.2.0'

    implementation group: 'org.owasp.encoder', name: 'encoder-jsp', version: '1.2.2'
    implementation group: 'com.googlecode.json-simple', name: 'json-simple', version: '1.1.1'
    implementation group: 'xalan', name: 'xalan', version: '2.7.2'

    providedCompile group: 'org.apache.tomcat', name: 'catalina', version: '6.0.53'
    providedCompile group: 'javax.servlet', name: 'javax.servlet-api', version: '3.0.1'
    providedCompile group: 'javax.servlet', name: 'javax.servlet-api', version: '3.1.0'
    providedCompile group: 'javax.xml.bind', name: 'jaxb-api', version: '2.3.0'

    // ---- NGAP libraries -----
    implementation group: 'com.amazonaws', name: 'elasticache-java-cluster-client', version: '1.1.2'
    implementation group: 'com.esotericsoftware', name: 'kryo', version: '4.0.2'
    implementation group: 'de.javakaffee', name: 'kryo-serializers', version: '0.45'
    implementation group: 'de.javakaffee.msm', name: 'memcached-session-manager', version: '2.3.2'
    implementation group: 'de.javakaffee.msm', name: 'memcached-session-manager-tc7', version: '2.3.2'

    implementation group: 'com.esotericsoftware', name: 'minlog', version: '1.3.0'
    implementation group: 'de.javakaffee.msm', name: 'msm-kryo-serializer', version: '2.3.2'
    implementation group: 'org.redisson', name: 'redisson-all', version: '3.11.6'
    implementation group: 'com.esotericsoftware', name: 'reflectasm', version: '1.11.9'
}

/*
configurations {
    all {
        // Exclude the '...starter-loggin' stuff if you want to use something other than
        // the ch.qos.Logback code. Without this, there will be errors about having two
        // conflicting implementations of slf4j. jhrg 11/7/18
        exclude group: 'org.springframework.boot', module: 'spring-boot-starter-logging'
    }
}
*/

// TODO Copy and filter the resources, then install the copied resources to the
//  war file by changing the 'resources/hyrax' in the 'from' line below to the
//  location of the copied/filtered resource files. jhrg 9/13/21

// See: https://docs.gradle.org/current/userguide/war_plugin.html
// We want to make multiple war files (opendap, ROOT, ngap) I think. This answer shows how:
// given that https://stackoverflow.com/questions/13077694/create-multiple-war-files-with-different-dependencies-in-gradle
war {
    println 'entered war build'
    // Not needed. Use this with a Spring project. jhrg 9/13/21 enabled = true
    //    webAppDirectory = file('src/main/webapp')
    //    from 'src/rootContent' // adds a file-set to the root of the archive
    from 'resources/hyrax'
    //from 'doc' to 'docs'
    //    webInf { from 'src/additionalWebInf' } // adds a file-set to the WEB-INF dir.
    //    classpath fileTree('additionalLibs') // adds a file-set to the WEB-INF/lib dir.
    //    classpath configurations.moreLibs // adds a configuration to the WEB-INF/lib dir.
    //    webXml = file('src/someWeb.xml') // copies a file to WEB-INF/web.xml
    doLast {
        println 'war build done'
    }
}

tasks.withType(JavaCompile) {
    //options.compilerArgs << '-Xlint:unchecked'
    //options.compilerArgs << '-Xlint:unchecked' << '-Werror' //enable to mark deprecated warnings as errors
    options.deprecation = true
}

tasks.register('hello') {
    description = "Goofy hello task"
    doLast {
        println('Hello world!')
    }
}
